// This schema is designed for PostgreSQL + TimescaleDB for the LC79 VMS

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

/// --- USER & RBAC ---

enum Role {
  COMMANDER
  OPERATOR
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  name          String
  password_hash String
  role          Role      @default(OPERATOR)
  preferences   Json?     // Used for "Glove Mode", "Night Mode", "Currency Toggle"
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt
  scans         OCRRecord[]
  trips         Trip[]
  assigned_vehicles Vehicle[] @relation("VehicleDriver")
}

/// --- VEHICLE ---

model Vehicle {
  id                String    @id @default(uuid())
  nickname          String?   // e.g., "The Beast", "79 Series"
  vin               String    @unique
  license_plate     String    @unique // CA-1234, XY-4567
  model_type        String    @default("Dual Cab") // Single Cab, Troopie, 76 Wagon
  gvm_limit_kg      Float     @default(3300)
  curb_weight_kg    Float     @default(2200)
  odometer_km       Float     @default(0)
  engine_hours      Float     @default(0)
  profile_photo_url String?
  assigned_driver_id String?
  assigned_driver   User?     @relation("VehicleDriver", fields: [assigned_driver_id], references: [id])
  documents         Document[]
  scans             OCRRecord[]
  fuel_logs         FuelLog[]
  service_logs      ServiceLog[]
  trips             Trip[]
}

/// --- V-EYE OCR MODULE ---

enum OCRCategory {
  FUEL_RECEIPT
  REVENUE_LICENSE
  INSURANCE_POLICY
  EMISSION_CERT
  SERVICE_INVOICE
  PART_ORDER
}

enum SyncStatus {
  PENDING
  SYNCED
  FAILED
}

model OCRRecord {
  id                String      @id @default(uuid())
  vehicle_id        String
  user_id           String
  category          OCRCategory
  image_url         String      // Local path or Cloud storage
  raw_text          String?     // The full unparsed OCR blob
  metadata          Json?       // Structured data: { "total_lkr": 5000, "liters": 12.5, "expiry": "2024-01-01" }
  confidence_score  Float       @default(0.0)
  sync_status       SyncStatus  @default(PENDING)
  processed_at      DateTime?
  created_at        DateTime    @default(now())

  vehicle           Vehicle     @relation(fields: [vehicle_id], references: [id])
  user              User        @relation(fields: [user_id], references: [id])
}

/// --- DOMAIN LOGS (Derived from OCR or Manual) ---

model FuelLog {
  id              String   @id @default(uuid())
  vehicle_id      String
  date            DateTime
  odometer        Float
  liters          Float
  price_per_liter Float
  total_lkr       Float
  fuel_type       String   // Super Diesel vs Lanka Diesel
  station_name    String?
  ocr_record_id   String?  @unique
  
  vehicle         Vehicle  @relation(fields: [vehicle_id], references: [id])
}

model ServiceLog {
  id              String   @id @default(uuid())
  vehicle_id      String
  date            DateTime
  odometer        Float
  service_type    String   // Minor, Major, Hub-Regrease
  total_lkr       Float
  parts_source    String   // Agent, MAP, OpenMarket
  invoice_url     String?
  notes           String?
  ocr_record_id   String?  @unique

  vehicle         Vehicle  @relation(fields: [vehicle_id], references: [id])
}

model Document {
  id              String   @id @default(uuid())
  vehicle_id      String
  type            String   // Revenue, Insurance, Emission
  expiry_date     DateTime
  document_url    String
  reminder_sent   Boolean  @default(false)

  vehicle         Vehicle  @relation(fields: [vehicle_id], references: [id])
}

/// --- TIMESCALEDB TELEMETRY (TRIPS) ---

model Trip {
  id                String   @id @default(uuid())
  vehicle_id        String
  user_id           String
  start_time        DateTime
  end_time          DateTime?
  start_odometer    Float
  end_odometer      Float?
  terrain_type      String?  // Narrow Village Road, Plantation Track, etc.
  corrugation_avg   Float?   // 1-10
  total_weight_kg   Float?   // Captured from GVM Scientist at start
  
  vehicle           Vehicle  @relation(fields: [vehicle_id], references: [id])
  user              User     @relation(fields: [user_id], references: [id])
}
